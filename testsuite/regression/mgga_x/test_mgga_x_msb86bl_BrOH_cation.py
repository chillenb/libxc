
import pylibxc
import pytest
import numpy
from pylibxc.example_densities import test_data


def test_mgga_x_msb86bl_BrOH_cation_2_zk():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_msb86bl", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["zk"].flatten()
    ref_tgt = [-2.043159216495555e+01, -2.043169338739683e+01, -2.043214318881154e+01, -2.122775193593104e+01, -2.122835243943616e+01, -2.202539606690133e+01, -3.479267079664933e+00, -3.758240675257051e+00, -3.756822349333979e+00, -3.757735194518668e+00, -3.757246710701560e+00, -3.478315983032073e+00, -5.875725327554735e-01, -6.799456155631103e-01, -7.655921099552495e-01, -6.699703664493737e-01, -5.743044806294403e-01, -7.670661179182312e-01, -1.813488089385150e-01, -1.835716921333714e-01, -8.181133174865008e-01, -1.858937494899431e-01, -2.102520989162660e-01, -2.001025259219553e-01, -2.058545896241019e-02, -1.433045486518633e-02, -5.545059431035047e-02, -1.435284623137107e-02, -1.760872477055990e-02, -1.760872477055990e-02, -5.324105370332505e+00, -5.324291851622862e+00, -5.324108482944661e+00, -5.324273555745531e+00, -5.209216004295728e+00, -5.209312360743640e+00, -2.146614954671632e+00, -2.155435544187485e+00, -2.140658118803244e+00, -2.148228238751317e+00, -1.973665553209993e+00, -2.154369235268986e+00, -5.813644263828640e-01, -6.562217206437775e-01, -5.820752700388300e-01, -5.937057907212626e-01, -5.925107776134234e-01, -6.252792632989483e-01, -1.501728703616348e-01, -1.883977852263173e-01, -1.423784780452048e-01, -2.005713668161974e+00, -1.588818605624988e-01, -1.588818605624988e-01, -7.704586661798250e-03, -1.426611912840707e-02, -1.009426054788049e-02, -7.758386667041606e-02, -1.260522234077583e-02, -1.260522234077583e-02, -5.945798155683466e-01, -5.941910639403164e-01, -5.863066994172796e-01, -5.913213573273695e-01, -5.873007114643656e-01, -5.908133619093467e-01, -5.788686379867514e-01, -4.899775487349630e-01, -5.095775887545664e-01, -5.541205385793119e-01, -5.461996965995450e-01, -5.217859498559502e-01, -6.633481499468693e-01, -2.694969442553154e-01, -2.691404499579588e-01, -3.488068203167803e-01, -3.404341486958670e-01, -3.045117481735712e-01, -4.884716537045513e-01, -2.857794619627404e-02, -9.334048379888313e-02, -3.605170465639217e-01, -1.227168190698814e-01, -1.227168190698815e-01, -7.260968880507042e-03, -5.778487727489933e-03, -1.631852824616240e-03, -5.793878095672080e-02, -1.164796934285890e-02, -5.003861029944035e-03]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-08


def test_mgga_x_msb86bl_BrOH_cation_2_vrho():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_msb86bl", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vrho"].flatten()
    ref_tgt = [-2.962077478945852e+01, -2.962097107405562e+01, -2.962090493794733e+01, -2.962106550332965e+01, -2.962132719392577e+01, -2.962166842050375e+01, -2.961985913984819e+01, -2.782561751671608e+01, -2.962085300322279e+01, -2.782627994664113e+01, -2.782658195586767e+01, -2.782627994664113e+01, -4.353872408395711e+00, -4.558360819035261e+00, -4.353955136116810e+00, -4.353806818325736e+00, -4.355543225477189e+00, -4.355873114668779e+00, -4.355333052477309e+00, -4.355395987196812e+00, -4.352990364194948e+00, -4.356909074838597e+00, -4.557924150868123e+00, -4.356909074838597e+00, -8.274059755624802e-01, -8.338793568152322e-01, -8.252149670030920e-01, -8.078644563509126e-01, -7.812224791964772e-01, -7.750260742148647e-01, -7.858920036702890e-01, -8.073588551107550e-01, -8.423879261235425e-01, -7.626914736942422e-01, -8.155695761974385e-01, -7.536026946786604e-01, -1.996311841316811e-01, -2.087563045678685e-01, -2.026633165891473e-01, -2.128993893618626e-01, -9.052640038198031e-01, -9.397429470768769e-01, -1.616834398160972e-01, -1.612234405455327e-01, -2.089960465155583e-01, -1.374470372311375e-01, -2.089960465155582e-01, -1.082898488041571e-01, -1.890830464277694e-02, -1.977708494461670e-02, -6.959212825901152e-03, -2.054318554606648e-02, -3.869717651939816e-02, -7.474223084488094e-02, -1.327293740620348e-02, -1.310258467260263e-02, -1.743058799712354e-02, -1.111650133423009e-02, -1.743058799712355e-02, -1.111650133423073e-02, -6.837236610214773e+00, -6.835604962466320e+00, -6.839493817269074e+00, -6.837785616184612e+00, -6.837382771112161e+00, -6.835694839593048e+00, -6.839318883832945e+00, -6.837675178358956e+00, -7.182440696463683e+00, -6.836697750529037e+00, -6.838377210805250e+00, -7.180713865538072e+00, -2.423516172522409e+00, -2.423951085969828e+00, -2.446881839694540e+00, -2.446602442673224e+00, -2.403579175532787e+00, -2.409702038018073e+00, -2.423867900237390e+00, -2.430244471891107e+00, -2.451567001780893e+00, -2.601119285898336e+00, -2.451567001780893e+00, -2.437950231867608e+00, -7.514595613831857e-01, -7.344564648261740e-01, -8.310124514760744e-01, -8.321767558460010e-01, -6.684789460482183e-01, -6.994254109836570e-01, -7.084970907630330e-01, -7.360220228384565e-01, -7.867420419826997e-01, -7.303627960293232e-01, -7.867420419826999e-01, -7.436575907199113e-01, -1.309283920491774e-01, -1.316538055960486e-01, -1.997293910613065e-01, -2.058217231466800e-01, -1.240812312453715e-01, -1.266390805252328e-01, -2.471771850956751e+00, -2.470726443024561e+00, -1.366094834075376e-01, -1.373973992510495e-01, -1.366094834075378e-01, -1.373973992510494e-01, -2.994927000540429e-03, -1.140168252108568e-02, -1.295273938637284e-02, -1.320847384583225e-02, -9.167590703197552e-03, -9.502042022410628e-03, -9.878082167515977e-02, -6.479972006934473e-02, -1.043602278019082e-02, -1.216262928193415e-02, -1.043602278019148e-02, -1.216262928195171e-02, -7.830237959741045e-01, -7.861664352377489e-01, -7.746124350632235e-01, -7.778007652982787e-01, -7.902929565119271e-01, -7.930930685528244e-01, -7.896847979945547e-01, -7.831510795920786e-01, -7.899480749760568e-01, -7.927830621874559e-01, -7.899480749760569e-01, -7.819429359633864e-01, -7.614754902447571e-01, -7.641227952762011e-01, -6.230418672731723e-01, -6.142807409232725e-01, -6.621366694938141e-01, -6.754784557505659e-01, -7.019673764390123e-01, -7.045732395370724e-01, -6.816885815344759e-01, -6.844503253149052e-01, -6.816885815344759e-01, -7.218747018532785e-01, -8.660444364459619e-01, -9.220783041674722e-01, -2.575681783818723e-01, -2.591157795636990e-01, -3.181967634321964e-01, -3.160834491432395e-01, -4.579197395371697e-01, -4.312742812986620e-01, -3.680856414446529e-01, -3.680997795247756e-01, -3.680856414446528e-01, -3.870345997390545e-01, -5.662495919262691e-01, -5.714125200623852e-01, -3.797331348269440e-02, -3.823314280695132e-02, -8.754771725498646e-02, -8.903804167471277e-02, -4.160640077284588e-01, -4.261010953557841e-01, -1.082791186459059e-01, -1.085035443739168e-01, -1.082791186459052e-01, -1.085035443739173e-01, -9.499895495367299e-03, -9.844308677142397e-03, -5.067763932164887e-03, -5.077477976572265e-03, -2.102791867398064e-03, -2.236488896936915e-03, -7.664120108522643e-02, -7.790376828524227e-02, -9.397106266956759e-03, -1.137954620439357e-02, -9.397106266918941e-03, -3.692773547394565e-03]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_x_msb86bl_BrOH_cation_2_vsigma():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_msb86bl", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vsigma"].flatten()
    ref_tgt = [-2.668350805304741e-08, 0.000000000000000e+00, -2.668600161848248e-08, -2.668350933090201e-08, 0.000000000000000e+00, -2.668600157013674e-08, -2.668331500588464e-08, 0.000000000000000e+00, -2.668577509774439e-08, -2.668332591584862e-08, 0.000000000000000e+00, -7.301590545626377e-09, -2.668352775913214e-08, 0.000000000000000e+00, -7.301122571774561e-09, -7.300714925903286e-09, 0.000000000000000e+00, -7.301122571774561e-09, -9.253944463044520e-06, 0.000000000000000e+00, -1.983547363883009e-05, -9.254323458097559e-06, 0.000000000000000e+00, -9.254324078966496e-06, -9.261839064428407e-06, 0.000000000000000e+00, -9.262791354391386e-06, -9.255988668628076e-06, 0.000000000000000e+00, -9.255482009369139e-06, -9.259033200134376e-06, 0.000000000000000e+00, -9.261539535313025e-06, -1.985360782806097e-05, 0.000000000000000e+00, -9.261539535313025e-06, -1.235953931865338e-02, 0.000000000000000e+00, -1.227915482303569e-02, -1.240443629873780e-02, 0.000000000000000e+00, -5.592044682634460e-03, -5.893868791425859e-03, 0.000000000000000e+00, -6.010118945024191e-03, -5.900513428096398e-03, 0.000000000000000e+00, -1.297486258680908e-02, -1.198393890000489e-02, 0.000000000000000e+00, -1.445373154819828e-02, -5.447844405502376e-03, 0.000000000000000e+00, -6.417374800113515e-03, -2.712831951884650e+00, 0.000000000000000e+00, -1.025263094916507e+00, -2.593111056659044e+00, 0.000000000000000e+00, -9.804588083639663e-01, -2.499074037204955e-03, 0.000000000000000e+00, -5.699972333518384e-03, -1.823884172190001e+00, 0.000000000000000e+00, -1.905650851540698e+00, -9.371343152836995e-01, 0.000000000000000e+00, -3.241768585417353e+00, -9.371343152836998e-01, 0.000000000000000e+00, -2.687841433974904e+01, -2.544658724223912e+03, 0.000000000000000e+00, -2.205207565323452e+03, -1.569518755248156e+06, 0.000000000000000e+00, -1.970708444766091e+03, -1.641824300336805e+03, 0.000000000000000e+00, -2.917914514712610e+01, -7.578422216129138e+03, 0.000000000000000e+00, -7.921974893151567e+03, -3.273104074388990e+03, 0.000000000000000e+00, -1.564703103919768e+04, -3.273104074388990e+03, 0.000000000000000e+00, -1.564703103919228e+04, -2.108076018288917e-06, 0.000000000000000e+00, -2.110101754499549e-06, -2.107245894042632e-06, 0.000000000000000e+00, -2.109299243538809e-06, -2.108032089065357e-06, 0.000000000000000e+00, -2.110075814012793e-06, -2.107319408062319e-06, 0.000000000000000e+00, -2.109346367922401e-06, -7.353044730029338e-06, 0.000000000000000e+00, -2.109698610576863e-06, -2.107649550659267e-06, 0.000000000000000e+00, -7.360475326769372e-06, -8.872113588589690e-05, 0.000000000000000e+00, -8.881555615943531e-05, -8.687846040069046e-05, 0.000000000000000e+00, -8.702339275519350e-05, -9.024065830974532e-05, 0.000000000000000e+00, -8.989883038266818e-05, -8.864047610941074e-05, 0.000000000000000e+00, -8.827684249083235e-05, -8.657369784220072e-05, 0.000000000000000e+00, -2.037880537887583e-04, -8.657369784220072e-05, 0.000000000000000e+00, -8.772660242630604e-05, -1.213761025531773e-02, 0.000000000000000e+00, -1.869610887865172e-02, -9.238816578634726e-03, 0.000000000000000e+00, -9.244297678865433e-03, -1.688414980815172e-02, 0.000000000000000e+00, -1.504666017396963e-02, -1.515887525405379e-02, 0.000000000000000e+00, -1.350808178314939e-02, -1.056844210338232e-02, 0.000000000000000e+00, -2.017034708012344e-02, -1.056844210338231e-02, 0.000000000000000e+00, -1.277972129783336e-02, -3.938439703303017e+00, 0.000000000000000e+00, -3.854260423132315e+00, -2.470239138911629e+00, 0.000000000000000e+00, -8.182001633710080e-01, -4.853448800992225e+00, 0.000000000000000e+00, -4.491741760101750e+00, -1.083312854111766e-04, 0.000000000000000e+00, -1.085340331385246e-04, -3.394982409079046e+00, 0.000000000000000e+00, -3.459303503959305e+00, -3.394982409079025e+00, 0.000000000000000e+00, -3.459303503959315e+00, -4.575746330363049e+07, 0.000000000000000e+00, -1.171537011883880e+04, -8.137428890994301e+03, 0.000000000000000e+00, -7.462415057659654e+03, -3.604961895703508e+04, 0.000000000000000e+00, -3.262623585634571e+04, -1.152400774901047e+01, 0.000000000000000e+00, -2.089693833226208e+02, -1.754391098789957e+04, 0.000000000000000e+00, -1.305520637701438e+04, -1.754391098789328e+04, 0.000000000000000e+00, -1.305520637689757e+04, -1.334618044887456e-02, 0.000000000000000e+00, -1.314626971871473e-02, -1.349809926525563e-02, 0.000000000000000e+00, -1.329594525733789e-02, -3.019989150084638e-02, 0.000000000000000e+00, -2.934976539102553e-02, -2.713122592365328e-02, 0.000000000000000e+00, -1.319996731779293e-02, -2.866961673460592e-02, 0.000000000000000e+00, -2.788423042745287e-02, -2.866961673460592e-02, 0.000000000000000e+00, -1.322143438970988e-02, -1.485590191131056e-02, 0.000000000000000e+00, -1.466687340158844e-02, -2.419207216476155e-02, 0.000000000000000e+00, -3.421461194713998e-02, -2.100424842192834e-02, 0.000000000000000e+00, -4.674714756147248e-02, -1.827802297841570e-02, 0.000000000000000e+00, -1.803210654807728e-02, -1.960850951503539e-02, 0.000000000000000e+00, -1.933691374298965e-02, -1.960850951503539e-02, 0.000000000000000e+00, -6.305795136324673e-02, -7.560660317177690e-03, 0.000000000000000e+00, -2.626057042850932e-02, -4.077386954671745e-01, 0.000000000000000e+00, -4.006379662220914e-01, -5.080062907038270e-01, 0.000000000000000e+00, -2.227694700593958e-01, -2.091905343967777e-01, 0.000000000000000e+00, -8.784159417889301e-02, -1.449747870643552e-01, 0.000000000000000e+00, -1.454459344926092e-01, -1.449747870643557e-01, 0.000000000000000e+00, -3.269270397554649e-01, -3.262150190124183e-02, 0.000000000000000e+00, -3.197108420277994e-02, -1.770634498411295e+03, 0.000000000000000e+00, -1.722991611706540e+03, -1.695741149088591e+01, 0.000000000000000e+00, -1.614144479149613e+01, -1.102744453435117e-01, 0.000000000000000e+00, -1.069206458596774e-01, -8.342830220760012e+00, 0.000000000000000e+00, -8.335590221362374e+00, -8.342830220760304e+00, 0.000000000000000e+00, -8.335590221362185e+00, -4.519930118633532e+05, 0.000000000000000e+00, -3.919820296758488e+05, -2.005727041636927e+05, 0.000000000000000e+00, -1.991255392708832e+05, -1.882876131492231e+08, 0.000000000000000e+00, -1.471431061297420e+08, -1.069344487077141e+02, 0.000000000000000e+00, -1.002141488790504e+02, -2.921830188663783e+04, 0.000000000000000e+00, -1.631274979824720e+04, -2.921830188732875e+04, 0.000000000000000e+00, -1.979685570737145e+07]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_x_msb86bl_BrOH_cation_2_vtau():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_msb86bl", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vtau"].flatten()
    ref_tgt = [1.394632495852144e-03, 1.394840043340489e-03, 1.394658211615134e-03, 1.394858646053466e-03, 1.394728215090685e-03, 1.394962120440188e-03, 1.394439913300195e-03, -3.721207474826483e-20, 1.394649232137755e-03, 1.359080308593282e-19, -4.039552377811194e-19, 1.359080308593282e-19, -3.760475288507037e-18, 2.190448058113139e-03, 7.571043103381861e-18, 2.758753928155163e-18, -3.520358530396473e-18, -3.506041368520966e-18, -7.597771042367527e-19, 9.771028577328406e-19, 2.502207677640105e-18, 3.895379626769469e-18, 2.192568093603844e-03, 3.895379626769469e-18, 4.352429647132228e-03, 4.664902228099773e-03, 4.266765012500470e-03, -5.544123454069633e-17, 4.889025169583034e-17, 3.006912578997158e-17, -4.330162387804958e-17, 3.773617030239560e-03, 4.849617017266905e-03, 2.421852520386822e-03, -1.374886814462477e-17, -3.628046995584568e-18, 4.046555625832198e-03, -1.045490246239253e-16, 4.531539974042592e-03, -3.313043005814320e-18, -5.225036092394178e-17, 1.106748548387717e-03, 1.538169591000614e-16, -3.667486271732298e-17, -1.072300814069680e-16, -3.559194355644621e-16, -8.103466443191405e-17, 4.059876502403838e-05, 5.429694544844907e-15, -5.342133708052864e-15, 2.105634021556220e-10, -1.544151474634916e-15, 3.754258176483694e-07, 2.412929277689230e-16, 4.814918592279073e-14, 1.495918984422774e-14, 2.082626325310016e-14, -3.365739959429176e-14, 2.082626325310016e-14, -3.477988398420293e-14, 9.417708125908977e-20, 5.866360318461835e-19, -2.366206774392867e-19, -1.452483534804637e-19, -1.734504224931567e-19, -1.261222390474528e-18, 4.138299041457939e-19, -6.516517155514418e-19, 5.626521052914271e-03, -3.412860626512005e-20, -6.345438310953234e-19, 5.628150578972711e-03, -7.450944210654616e-18, 9.413180045177433e-18, 1.890840346045430e-18, 1.150583294591478e-17, -2.582415087832573e-18, 4.085427416102440e-18, -8.323785174338551e-18, 5.636138898273778e-18, -1.833232417893257e-18, 4.275911325174190e-03, -1.833232417893257e-18, 7.416388884218133e-19, 2.548686729667252e-17, 3.990522398988659e-03, -7.348118913774848e-19, 1.068756266896060e-18, 4.193824781397487e-17, 2.577332677484802e-17, 3.929059933715364e-18, -2.243211421492774e-18, 9.088230737304368e-18, 5.236628558185145e-03, -1.227666651068624e-17, -1.751382393552273e-17, 6.650257622343617e-16, 6.009849923516759e-16, 1.194300754224547e-03, 2.175241892899210e-16, 2.755725781778372e-16, 3.998896326423083e-16, -1.178245738583441e-18, 1.538738500465149e-18, 8.081288106432366e-17, -2.590646621128097e-16, -1.085998296115143e-16, -1.828474614261084e-16, 1.139949575564287e-12, 2.661591623479980e-14, 8.897306125973461e-15, -2.143628890108066e-14, -2.763371106130019e-14, -1.606529705704920e-14, -1.797370412124454e-15, 6.871163801210266e-06, -5.919354852837282e-15, 3.088150346224355e-14, -6.778698153731660e-15, -1.034900476283660e-14, 1.234093070637838e-18, 2.547279638539230e-19, 6.788616836763748e-18, 4.091611905978562e-18, 2.608972238890091e-02, 2.538143735423228e-02, 2.152890644156010e-02, -2.625942062597248e-18, 2.382397756915822e-02, 2.318423868577256e-02, 2.382397756915822e-02, -2.704842889155441e-18, 2.932439978001497e-19, -6.986059117456956e-20, 1.097914426107765e-17, 1.884899057766733e-03, -9.999331984085163e-18, 2.210763477461665e-02, -1.279167706210362e-17, -1.110274243462962e-17, 2.213997285538429e-18, 2.797682628466898e-17, -1.402693351773390e-18, 4.582949958563733e-02, 1.677363733525146e-18, 4.064955363761863e-02, 8.291294554301391e-17, -7.997016112399942e-17, 7.703907415121904e-03, -3.432383160439679e-17, 2.348271114446715e-02, -3.889717713280218e-17, -2.063475857521167e-17, 6.689361128807124e-17, 4.018645126750695e-17, 1.739961186544742e-02, 2.750718693776769e-17, -9.845221228430655e-18, 3.688264321821777e-07, 3.702662200707459e-07, -6.254187927603338e-16, 5.022924736955538e-16, -8.211758331892778e-17, -3.919093775561449e-17, 7.016670356838523e-17, 6.069699157584673e-16, 8.587387105534032e-16, -1.345466204088843e-17, 3.170735170150867e-10, 3.707345576504698e-10, -1.252485626788344e-14, -1.496988727694673e-13, 1.648614172575290e-12, 2.446806092140700e-12, 2.385631770075838e-05, 3.082762688979962e-05, -3.190237465764551e-14, 3.598391757444627e-14, 4.812224604842281e-14, 4.576903238280458e-11]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


import pylibxc
import pytest
import numpy
from pylibxc.example_densities import test_data


def test_mgga_x_mspbel_BrOH_cation_2_zk():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_mspbel", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["zk"].flatten()
    ref_tgt = numpy.asarray([-2.051224229161337e+01, -2.051234959463030e+01, -2.051282414289032e+01, -2.135014865279244e+01, -2.135078364273159e+01, -2.218962756713300e+01, -3.482103021647001e+00, -3.767487032534831e+00, -3.766264190278037e+00, -3.767099031761393e+00, -3.766617860827952e+00, -3.481289754245429e+00, -5.829528719211470e-01, -6.752705897095874e-01, -7.587542411377896e-01, -6.645634938612768e-01, -5.695106700254368e-01, -7.609518390728152e-01, -1.791393712395001e-01, -1.815026526882325e-01, -8.050049030536648e-01, -1.767348080845539e-01, -2.048195172121414e-01, -1.967024107809067e-01, -1.010117671342812e-02, -8.358828655687597e-03, -4.486140738267283e-02, -5.828414940513071e-03, -8.132113616774532e-03, -8.132113616774532e-03, -5.368000093020072e+00, -5.368261008017024e+00, -5.368007433197770e+00, -5.368238173766107e+00, -5.248520495594452e+00, -5.248620285011104e+00, -2.148050432139582e+00, -2.157710472050399e+00, -2.141412360485783e+00, -2.149761959386157e+00, -1.972496640672617e+00, -2.156596352481917e+00, -5.830533021280278e-01, -6.612142022330532e-01, -5.840791304078128e-01, -5.969724578340423e-01, -5.946540924246970e-01, -6.289683581059675e-01, -1.349544876944938e-01, -1.841203616912366e-01, -1.265393612858635e-01, -2.018060327970184e+00, -1.487985338324211e-01, -1.487985338324211e-01, -3.469050178739257e-03, -5.697808219119506e-03, -4.362644018133032e-03, -6.838234658098286e-02, -5.479782736291176e-03, -5.479782736291178e-03, -6.002177404744780e-01, -5.995607774562675e-01, -5.917590984934733e-01, -5.968860078946248e-01, -5.928245453654648e-01, -5.963253172915526e-01, -5.843224178051800e-01, -4.910858353489340e-01, -5.113658307427641e-01, -5.583778079780988e-01, -5.499911504933750e-01, -5.242410430732055e-01, -6.667191672683095e-01, -2.649278696415626e-01, -2.668554668472510e-01, -3.484013646106188e-01, -3.394903318896909e-01, -3.032290085042546e-01, -4.898414808880943e-01, -2.824431406693291e-02, -7.359576678270505e-02, -3.615981820667649e-01, -1.087085248379169e-01, -1.087085248379169e-01, -7.176194109940155e-03, -1.523282825264551e-03, -1.612800272023610e-03, -5.726387751832070e-02, -5.032539554319147e-03, -3.141517970425492e-03])
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-08


def test_mgga_x_mspbel_BrOH_cation_2_vrho():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_mspbel", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vrho"].flatten()
    ref_tgt = numpy.asarray([-3.004313737165325e+01, -3.004336414050882e+01, -3.004327344463657e+01, -3.004346285794606e+01, -3.004371320278070e+01, -3.004409119507396e+01, -3.004217853032044e+01, -2.818082050188330e+01, -3.004321930969252e+01, -2.818147379710259e+01, -2.818178668031178e+01, -2.818147379710259e+01, -4.441684104045315e+00, -4.592166304872825e+00, -4.441751078351202e+00, -4.441620057079364e+00, -4.443033540606526e+00, -4.443309847875763e+00, -4.442941658938906e+00, -4.443005404852229e+00, -4.440823106079814e+00, -4.444245611344776e+00, -4.591759304970032e+00, -4.444245611344777e+00, -8.272855258414153e-01, -8.341811358985735e-01, -8.249751447082359e-01, -8.363870872120996e-01, -8.127576516358026e-01, -8.069474827707217e-01, -8.163452077558674e-01, -8.063997788097624e-01, -8.429717221548859e-01, -7.597533535256668e-01, -8.438068122491482e-01, -7.870894814640461e-01, -1.982402475549857e-01, -2.190004153406150e-01, -2.013309809739257e-01, -2.227870106224832e-01, -9.618026264917393e-01, -9.339506617239882e-01, -1.785377923868798e-01, -1.770341250363947e-01, -2.207730631046221e-01, -1.531865809832029e-01, -2.207730631046219e-01, -1.070421163758855e-01, -1.299806160511439e-02, -1.380647548982901e-02, -6.877961206051757e-03, -1.457801912718506e-02, -3.824550248525384e-02, -7.422933184092242e-02, -7.829906738362173e-03, -7.699640943253044e-03, -1.160340980289051e-02, -6.612044062446551e-03, -1.160340980289051e-02, -6.612044062446552e-03, -6.917801754364746e+00, -6.916150162387727e+00, -6.919970915274789e+00, -6.918245728637671e+00, -6.917941629615728e+00, -6.916236109453379e+00, -6.919802258193549e+00, -6.918139214752133e+00, -7.280197220767880e+00, -6.917200339894460e+00, -6.918898244027458e+00, -7.278449875488265e+00, -2.479773886840241e+00, -2.480049506332504e+00, -2.502033677151209e+00, -2.501635057496075e+00, -2.460910548192651e+00, -2.466562568628281e+00, -2.480165122181568e+00, -2.486081786202013e+00, -2.506438462262043e+00, -2.623483810391920e+00, -2.506438462262042e+00, -2.493359877615186e+00, -7.631903826492300e-01, -7.357035798134454e-01, -8.415106429744593e-01, -8.425871688196690e-01, -6.816489378843879e-01, -7.117520867079838e-01, -7.198041425909987e-01, -7.470629588354382e-01, -7.981383552613119e-01, -7.319485622242279e-01, -7.981383552613120e-01, -7.550784254121552e-01, -1.459515217482177e-01, -1.468047438282537e-01, -1.978279906258232e-01, -2.218544961194659e-01, -1.376076487635824e-01, -1.409858304000664e-01, -2.507651793475154e+00, -2.506580707428685e+00, -1.523666336889582e-01, -1.520259015996915e-01, -1.523666336889584e-01, -1.520259015996915e-01, -2.959959996828338e-03, -6.107306444055478e-03, -7.534446307833160e-03, -7.648691213020454e-03, -5.631667009299493e-03, -5.962806725572809e-03, -1.059656660068681e-01, -6.404531357867556e-02, -5.755896483546882e-03, -7.893950895914253e-03, -5.755896483546885e-03, -7.893950895914296e-03, -7.911569164583606e-01, -7.943214882689117e-01, -7.830359706135972e-01, -7.862423930361060e-01, -7.988830378745365e-01, -8.016790107025762e-01, -7.980324456915555e-01, -7.914062721838790e-01, -7.984116080944181e-01, -8.012485091947996e-01, -7.984116080944181e-01, -7.902393568867778e-01, -7.694348440014762e-01, -7.720976277758197e-01, -6.337969436556281e-01, -6.147703613381652e-01, -6.717733669538622e-01, -6.802523982161376e-01, -7.107341992586572e-01, -7.133549188029574e-01, -6.908664940432618e-01, -6.936323161494680e-01, -6.908664940432618e-01, -7.309708346655915e-01, -8.776208730008399e-01, -9.345951516348268e-01, -2.719959389490194e-01, -2.734804658157881e-01, -3.174245504945818e-01, -3.285779641155940e-01, -4.617517276611535e-01, -4.414070618950414e-01, -3.788962722876497e-01, -3.788496109274996e-01, -3.788962722876496e-01, -3.887577106748926e-01, -5.775059483700532e-01, -5.824642984753146e-01, -3.753008527829482e-02, -3.778688275801090e-02, -8.991695669292264e-02, -9.212139692260288e-02, -4.245448992624943e-01, -4.338874275824107e-01, -1.197163861869734e-01, -1.208016989052035e-01, -1.197163861869730e-01, -1.208016989052038e-01, -9.388980422519275e-03, -9.729372458866967e-03, -2.028628440794342e-03, -2.033264693277626e-03, -2.078240908055332e-03, -2.210376969925958e-03, -7.575292762126028e-02, -7.700218813787642e-02, -5.450670235268531e-03, -7.237411791374017e-03, -5.450670235268497e-03, -3.649658904375519e-03])
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_x_mspbel_BrOH_cation_2_vsigma():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_mspbel", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vsigma"].flatten()
    ref_tgt = numpy.asarray([-2.885190207191238e-08, 0.000000000000000e+00, -2.885463358115209e-08, -2.885190865076810e-08, 0.000000000000000e+00, -2.885463727221916e-08, -2.885171318320009e-08, 0.000000000000000e+00, -2.885441377191763e-08, -2.885166654637407e-08, 0.000000000000000e+00, -6.656017018195492e-09, -2.885192671236824e-08, 0.000000000000000e+00, -6.655610517587339e-09, -6.655230894247290e-09, 0.000000000000000e+00, -6.655610517587339e-09, -8.190976831520597e-06, 0.000000000000000e+00, -2.078884263418822e-05, -8.191426219461477e-06, 0.000000000000000e+00, -8.191294101587281e-06, -8.200290193198758e-06, 0.000000000000000e+00, -8.201528224014283e-06, -8.194307795388333e-06, 0.000000000000000e+00, -8.193862228531982e-06, -8.195226946654048e-06, 0.000000000000000e+00, -8.201213557896934e-06, -2.080851651568017e-05, 0.000000000000000e+00, -8.201213557896934e-06, -1.301974755273582e-02, 0.000000000000000e+00, -1.293756088880635e-02, -1.306635403868708e-02, 0.000000000000000e+00, -4.723606340677537e-03, -4.907376022781731e-03, 0.000000000000000e+00, -4.992577871793148e-03, -4.935443668848770e-03, 0.000000000000000e+00, -1.366310246195515e-02, -1.262818502665467e-02, 0.000000000000000e+00, -1.521122208888363e-02, -4.610860629675753e-03, 0.000000000000000e+00, -5.282302874798071e-03, -2.854924697293640e+00, 0.000000000000000e+00, -8.329477003340771e-01, -2.728814915264735e+00, 0.000000000000000e+00, -8.024880801585470e-01, -1.952842639390211e-03, 0.000000000000000e+00, -5.998087488311389e-03, -1.198722899373385e+00, 0.000000000000000e+00, -1.299866448207365e+00, -7.456415322969125e-01, 0.000000000000000e+00, -1.562732034441840e+00, -7.456415322969127e-01, 0.000000000000000e+00, -2.833901386522569e+01, -8.483527620994403e+00, 0.000000000000000e+00, -8.513390100022013e+00, -1.655036182407334e+06, 0.000000000000000e+00, -8.900771928607947e+00, -1.731275578359637e+03, 0.000000000000000e+00, -3.911357125985648e+00, -6.223769805526104e+00, 0.000000000000000e+00, -6.287681992683699e+00, -8.064426474325334e+00, 0.000000000000000e+00, -1.382366062717246e+01, -8.064426474325334e+00, 0.000000000000000e+00, -1.382366062716692e+01, -1.931089919837447e-06, 0.000000000000000e+00, -1.932946635173568e-06, -1.930497311668822e-06, 0.000000000000000e+00, -1.932373865457115e-06, -1.931061400196221e-06, 0.000000000000000e+00, -1.932930184063231e-06, -1.930552448652877e-06, 0.000000000000000e+00, -1.932409375346984e-06, -7.908359554697984e-06, 0.000000000000000e+00, -1.932658656835834e-06, -1.930783498644389e-06, 0.000000000000000e+00, -7.916371929584860e-06, -7.773110426230940e-05, 0.000000000000000e+00, -7.783154746410815e-05, -7.628486976733254e-05, 0.000000000000000e+00, -7.642376597141285e-05, -7.889894137652490e-05, 0.000000000000000e+00, -7.866503002010469e-05, -7.765716659577326e-05, 0.000000000000000e+00, -7.740174694048776e-05, -7.605680633544680e-05, 0.000000000000000e+00, -2.151643228133248e-04, -7.605680633544680e-05, 0.000000000000000e+00, -7.698185843460157e-05, -1.092757518308661e-02, 0.000000000000000e+00, -1.902138376943515e-02, -8.427312926998762e-03, 0.000000000000000e+00, -8.437347967955184e-03, -1.496916169888021e-02, 0.000000000000000e+00, -1.344093445142549e-02, -1.362852562998912e-02, 0.000000000000000e+00, -1.219195222154052e-02, -9.559532458112786e-03, 0.000000000000000e+00, -2.060818784547611e-02, -9.559532458112776e-03, 0.000000000000000e+00, -1.151754825779733e-02, -1.908891819867499e+00, 0.000000000000000e+00, -1.883894487219398e+00, -2.601388740007447e+00, 0.000000000000000e+00, -6.081776490249807e-01, -2.120999231331230e+00, 0.000000000000000e+00, -2.109551385651405e+00, -9.797674430152140e-05, 0.000000000000000e+00, -9.816189804779480e-05, -1.980890368527791e+00, 0.000000000000000e+00, -2.237432001587646e+00, -1.980890368527775e+00, 0.000000000000000e+00, -2.237432001587652e+00, -4.825062311660589e+07, 0.000000000000000e+00, -4.167368246557704e+00, -5.904088549102924e+00, 0.000000000000000e+00, -5.204342873630132e+00, -4.250368018219511e+01, 0.000000000000000e+00, -4.664787711079945e+01, -3.364686852393017e+00, 0.000000000000000e+00, -2.203483543015583e+02, -8.013032666952714e+00, 0.000000000000000e+00, -2.541874787375732e+01, -8.013032666940504e+00, 0.000000000000000e+00, -2.541874787348535e+01, -1.232142677138021e-02, 0.000000000000000e+00, -1.213787083061940e-02, -1.242598885643304e-02, 0.000000000000000e+00, -1.224138107858260e-02, -3.141425609205858e-02, 0.000000000000000e+00, -3.049239095595549e-02, -2.794277873221170e-02, 0.000000000000000e+00, -1.217515390809861e-02, -2.968273202635212e-02, 0.000000000000000e+00, -2.883438384490381e-02, -2.968273202635212e-02, 0.000000000000000e+00, -1.218997299706936e-02, -1.370977883025828e-02, 0.000000000000000e+00, -1.353663502410648e-02, -2.163986754511650e-02, 0.000000000000000e+00, -3.447998379686707e-02, -1.899352718698587e-02, 0.000000000000000e+00, -4.932056839155249e-02, -1.668420655560051e-02, 0.000000000000000e+00, -1.646175171316867e-02, -1.781675180763934e-02, 0.000000000000000e+00, -1.757384725900588e-02, -1.781675180763934e-02, 0.000000000000000e+00, -6.791699449600049e-02, -6.872819563200760e-03, 0.000000000000000e+00, -2.835523253137266e-02, -3.247377852807790e-01, 0.000000000000000e+00, -3.196173544445757e-01, -5.347717240337578e-01, 0.000000000000000e+00, -1.859229670767801e-01, -2.210127300744003e-01, 0.000000000000000e+00, -7.689012846049684e-02, -1.246068980312077e-01, 0.000000000000000e+00, -1.250742111781428e-01, -1.246068980312080e-01, 0.000000000000000e+00, -3.451056880445410e-01, -2.890359736236789e-02, 0.000000000000000e+00, -2.838106952876580e-02, -1.867103874449979e+03, 0.000000000000000e+00, -1.816865220651577e+03, -3.182273522988007e+00, 0.000000000000000e+00, -3.260100128023045e+00, -9.753490360898687e-02, 0.000000000000000e+00, -9.528091803222317e-02, -3.477275167813687e+00, 0.000000000000000e+00, -3.919075929151507e+00, -3.477275167813824e+00, 0.000000000000000e+00, -3.919075929151399e+00, -4.766204818588553e+05, 0.000000000000000e+00, -4.133397168876651e+05, -6.792513471048074e+00, 0.000000000000000e+00, -6.762646735936976e+00, -1.985467288536403e+08, 0.000000000000000e+00, -1.551604054319969e+08, -1.127519982928467e+02, 0.000000000000000e+00, -1.056645087605798e+02, -2.067640352890794e+01, 0.000000000000000e+00, -2.635873150860274e+01, -2.067640352948263e+01, 0.000000000000000e+00, -2.087551522991146e+07])
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_x_mspbel_BrOH_cation_2_vtau():
    # Prepare the input
    inp = test_data["BrOH_cation"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_x_mspbel", 2)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vtau"].flatten()
    ref_tgt = numpy.asarray([1.579221929131494e-03, 1.579456946991759e-03, 1.579251048556905e-03, 1.579478011904817e-03, 1.579330317485481e-03, 1.579595181855396e-03, 1.579003856922500e-03, -4.143454734344531e-20, 1.579240880582452e-03, 1.513300746497352e-19, -4.497931181143523e-19, 1.513300746497352e-19, -4.056967137460101e-18, 2.480369286019175e-03, 8.168097762618462e-18, 2.976258529082282e-18, -3.799070450442719e-18, -3.783814565808888e-18, -8.198439164468655e-19, 1.054351520227979e-18, 2.699402881626672e-18, 4.204434004340851e-18, 2.482769923138571e-03, 4.204434004340851e-18, 4.928504365269106e-03, 5.282334893084898e-03, 4.831501412904421e-03, -5.690997985531576e-17, 4.942679945355635e-17, 3.032475465735515e-17, -4.398908231916842e-17, 4.273081821929986e-03, 5.491497985552073e-03, 2.742401758665818e-03, -1.414253790193576e-17, -3.623713903475740e-18, 4.582145762966938e-03, -1.029945196054428e-16, 5.131321205427508e-03, -3.289415935315742e-18, -4.941446396403381e-17, 1.253234513641864e-03, 1.215570758721719e-16, -3.011531597195489e-17, -1.033468597568345e-16, -2.048663886648814e-16, -7.810008153125355e-17, 4.597229751372167e-05, 2.129680425593692e-17, -2.426446952248786e-17, 2.384329525693530e-10, -8.205619961507401e-18, 4.251160687512809e-07, 3.821286500954019e-17, 4.651555791401029e-17, 1.396686755329782e-17, 6.036684919311241e-17, -3.497903863618524e-17, 6.036684919311241e-17, -3.614560017424581e-17, 1.054162395343281e-19, 6.566459686940587e-19, -2.648839819117110e-19, -1.625972192724762e-19, -1.941513870443791e-19, -1.411744132870362e-18, 4.632569158390365e-19, -7.294836833962798e-19, 6.371230742084090e-03, -3.820329347744963e-20, -7.103041483538945e-19, 6.373075947393182e-03, -7.951104351764889e-18, 1.004749936474811e-17, 2.022524245763441e-18, 1.230913449845541e-17, -2.749689298826177e-18, 4.353891657791168e-18, -8.882137703318810e-18, 6.019445901116522e-18, -1.961992853231545e-18, 4.841858304478367e-03, -1.961992853231545e-18, 7.927642966219167e-19, 2.800159829380289e-17, 4.518696143906365e-03, -8.187511684592456e-19, 1.191608743770317e-18, 4.532394255765784e-17, 2.807949926700530e-17, 4.310242675461931e-18, -2.471188267527372e-18, 1.003532511376042e-17, 5.929733229648865e-03, -1.355603123523834e-17, -1.926319579915462e-17, 3.849036829416182e-16, 3.508313860499703e-16, 1.352374870554963e-03, 1.952576495297750e-16, 1.435735695959598e-16, 2.241529185081444e-16, -1.300849890887559e-18, 1.698887475792332e-18, 5.651664364885590e-17, -2.013803100975257e-16, -7.594949950608775e-17, -1.421339297387478e-16, 1.290829677595894e-12, 1.113701543106291e-17, 7.593748433704640e-18, -1.758601174971449e-17, -3.832734726491540e-17, -2.702112863732494e-17, -6.228231930768782e-16, 7.780610724188606e-06, -3.180309593301114e-18, 7.073441431458281e-17, -3.642011555322557e-18, -2.370450622686971e-17, 1.393050712695245e-18, 2.875639895538875e-19, 7.639322387150965e-18, 4.604951339658477e-18, 2.954288089804785e-02, 2.874084935056052e-02, 2.437840883806426e-02, -2.961211238744481e-18, 2.697724879367930e-02, 2.625283596337056e-02, 2.697724879367930e-02, -3.048839946519045e-18, 3.308732595764710e-19, -7.883333587624806e-20, 1.197903744811384e-17, 2.134378723482887e-03, -1.103789843227204e-17, 2.503373594200804e-02, -1.426363489765226e-17, -1.238198709568376e-17, 2.456602495871575e-18, 3.104983253783426e-17, -1.556397567159152e-18, 5.189535663482598e-02, 1.862047920090456e-18, 4.602980835801701e-02, 7.999198188153786e-17, -7.728859347380373e-17, 8.723573820446535e-03, -3.478746127844157e-17, 2.659081335412704e-02, -4.146774260398387e-17, -2.157546492055841e-17, 6.998025949709535e-17, 4.201848867984308e-17, 1.970257304201344e-02, 2.970807222663932e-17, -1.065453550596821e-17, 4.176432081424616e-07, 4.192735621001981e-07, -1.388755080104464e-16, 1.200879782691122e-16, -8.852153596754622e-17, -4.258780596200662e-17, 3.484305482571103e-17, 3.406050434085019e-16, 4.264284689333880e-16, -7.550169505117598e-18, 3.590404295958368e-10, 4.198038867569658e-10, -4.989325435438181e-19, -5.980240539321522e-18, 1.866819714289309e-12, 2.770658183343399e-12, 2.701386936946666e-05, 3.490788042889486e-05, -2.655672849725390e-17, 6.840061582184052e-17, 4.005875539094600e-17, 5.182688666726210e-11])
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


import pylibxc
import pytest
import numpy
from pylibxc.example_densities import test_data


def test_mgga_k_csk_loc1_BrOH_cation_restr_1_zk():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk_loc1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["zk"].flatten()
    ref_tgt = [2.084991934253608e+03, 2.084993439674390e+03, 2.085020001411417e+03, 2.084997045013944e+03, 2.085006240373232e+03, 2.085006240373232e+03, 5.973397114091204e+01, 5.973029698806224e+01, 5.964856270988381e+01, "nan", 5.973244582303415e+01, 6.748657691670338e+158, 2.829294728868489e+00, 3.999142102781801e+247, 8.076789598624721e+160, 4.524121384449758e+213, 1.974163066528686e+160, 4.547965768332178e+213, 3.689768671747560e+98, 2.639844758104218e+215, 3.600485267583262e+00, 3.002000832790162e+230, 4.836571370390768e+215, 4.013342030081827e+244, 6.236820823126644e+174, 4.175695584364503e+205, 2.305479926081705e+227, 1.250598136087166e+235, 5.565281961497925e+276, 4.650911783312199e+186, 2.346809477651569e+171, 4.721223949065379e+244, 3.087696456444548e+206, 1.198259121261085e+02, 2.809736727864130e+225, 3.904845316690034e+177, 3.119907633020982e+01, 3.109773155091535e+01, 3.215342816471100e+01, 3.205495524573303e+01, 3.069377518678549e+01, 4.503183103305446e+159, 2.138420848398177e+180, 2.931499336357286e+218, 3.804176070526488e+180, 4.217146322598707e+218, 2.038240031391262e+180, 1.642064745474519e+00, 9.225904442948688e-01, 1.846757843081674e+201, 9.001579503251458e-01, 1.228252896804395e+67, 5.017994493966003e+162, 1.144923318777937e+250, 6.674701690272700e-01, 7.950728572363663e+167, 2.999295662561143e+283, 8.108212654177965e-01, 4.129761055672417e-01, 7.246796232063289e+167, 9.323794505291327e+237, 1.040850873868459e+227, 1.535957788122509e+00, 2.139723841490365e+209, 2.552199175678665e+164, 6.167388804824337e+242, 4.423997709944032e+228, 2.377584248549258e+161, 4.748581671644741e+228, 7.748089174945189e+199, 2.680635944480411e+246, 1.297485602144309e+00, 2.196129317060045e+247, 1.082582218143405e+00, 4.361854005254243e+224, 8.240801635878808e-01, 1.678658789555290e+176, 9.581636470455021e+198, 1.289876566721348e+00, 1.335395916196389e+256, 5.292497178134141e+255, 2.189629241328669e+253, 7.146835320215421e-01, 6.784936013374339e+253, 4.171956334059106e+256, 7.178930183998836e+265, 2.824523923245744e+51, 1.492516516547518e+183, 4.056416141983144e+230, 1.052027479767924e+258]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-08


def test_mgga_k_csk_loc1_BrOH_cation_restr_1_vrho():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk_loc1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vrho"].flatten()
    ref_tgt = [2.566486791440940e+03, 2.566558720712268e+03, 2.566790585431797e+03, 2.565721728122106e+03, 2.566294320507935e+03, 2.566294320507935e+03, 4.819771846498821e+01, 4.821233144165621e+01, 4.855248515075041e+01, "nan", 4.821756334123943e+01, -3.723434875078846e+143, 1.596599240227449e-01, -7.775234665830337e+228, 3.028220733321210e+144, 1.896256793463810e+198, -5.128756434925045e+144, -1.230786436300061e+198, -6.436865011370805e+82, -9.050736802023904e+199, 7.726968250321079e-01, -2.839005181007609e+214, 4.274242175305496e+199, -8.836330003340068e+228, -2.140637999558249e+158, -1.702365862209171e+190, -1.070371965981029e+211, -3.328555292553498e+218, 7.758510556857293e+259, 1.288361385527866e+171, -5.777483488697387e+155, 9.142990171985982e+228, -2.687500693929608e+190, 1.828611088479582e+02, 2.926331008083390e+209, -5.401894952895583e+161, -1.166880973704083e+01, -1.093508222459420e+01, -1.358383179012203e+01, -1.295117827121767e+01, -1.032437176167543e+01, -2.224514699935798e+143, -7.887643669910792e+164, -4.085978508733923e+202, -1.344099809229834e+164, 1.132382382629685e+203, 1.124075365261747e+165, 1.903313003017237e+00, -9.191084326449177e-01, -4.043063229116847e+185, -8.975386426523561e-01, -2.819683852047708e+51, 4.699406446734538e+147, 2.861530360106315e+234, -6.674701653557972e-01, 1.179416101639866e+152, -6.773970694934900e+267, -8.102218803736414e-01, -4.129760945565530e-01, 4.483685346351848e+151, -2.356337432860358e+222, 6.818270941915698e+211, 2.633341623566918e+00, -6.669962137549514e+193, 1.758414701045458e+149, 2.291602936652690e+227, 5.049745056620749e+213, -3.204367040182918e+145, 5.161014981817030e+212, -9.326592748095563e+183, 5.527751307362938e+230, 1.411785827636673e+00, -2.084711922331380e+231, -9.890975224177891e-01, 4.823809688466674e+208, -8.712287835879549e-02, 5.570419368204589e+159, -7.345308080530187e+182, 7.809962576474183e-02, 7.873361856280054e+239, -2.556881448885758e+240, 1.297040507247203e+238, -7.129069176978354e-01, -2.239676996590854e+238, -2.272602172017112e+241, 1.049195490909868e+250, 5.628601512845028e+35, 5.700483021132050e+167, -4.477960676918883e+214, 3.823169287897557e+241]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_k_csk_loc1_BrOH_cation_restr_1_vsigma():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk_loc1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vsigma"].flatten()
    ref_tgt = [2.300177183903396e-06, 2.300037670849210e-06, 2.299604203014326e-06, 2.301677173003676e-06, 2.300564380191611e-06, 2.300564380191611e-06, 8.219530117672768e-04, 8.217800647689946e-04, 8.177094686006093e-04, "nan", 8.216862266134869e-04, -2.471854607025499e-04, 1.624961380036470e-01, -3.456445230125043e-02, -3.747154821060016e-02, -3.655372067844504e-02, -3.674637708045572e-02, -3.674637708045572e-02, -2.001093004756285e+00, -1.912859581637510e+00, 9.706927655876660e-02, -4.573325034448005e+00, -3.229874366910618e+00, -3.229874366910618e+00, -4.743672063494301e+04, -4.068151126847196e+04, -2.422499496422378e+02, -2.462567664530374e+05, -1.241141592272281e+05, -1.241141592272281e+05, -7.365580088314568e-05, -7.361524902557733e-05, -7.365378047946943e-05, 6.860444429976578e-05, -7.363532382973350e-05, -7.363532382973350e-05, 7.377037844166920e-03, 7.179459484293870e-03, 7.582931152442118e-03, 7.405722965446313e-03, 7.167017939947415e-03, -1.359961784283986e-03, -5.147064498040534e-02, -4.014649925333620e-02, -6.496940809307770e-02, -5.783913877351247e-02, -4.905934634633084e-02, 1.171492844070251e-01, 8.276181087138185e+01, -1.992003863966729e+00, 1.045436346781698e+02, -1.469649963077993e-03, -8.455385758481471e+00, -8.455385758481471e+00, 3.249256946653485e+06, -2.635845550857157e+05, -5.895697237861817e+05, 3.437463227043893e+02, 2.043738640485535e+06, -3.372168773658643e+05, -5.072812337927218e-02, -5.161120193721565e-02, -5.004992635603445e-02, -5.104218030221695e-02, -5.117008596656047e-02, -5.117008596656047e-02, -5.508749354100984e-02, -8.708461514668764e-02, -7.584074800241111e-02, -6.652222692147958e-02, -7.107784851001094e-02, 1.848579939882435e-01, -3.484221486319211e-02, 5.890421385431949e+00, -5.702373052167645e-01, 1.226233536445752e+00, -3.762401048661960e-01, -3.762401048661959e-01, 5.257068388898403e-01, -2.762835659547210e+02, -1.090293323885151e+02, -2.762058130411847e-01, 1.664508260315820e+02, -2.747713858330712e+01, -1.687524586439295e+04, -1.380040578158303e+07, -1.492200145125896e+06, -3.318298105938295e+01, -4.256411326421931e+05, -4.256411326421939e+05]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_k_csk_loc1_BrOH_cation_restr_1_vlapl():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk_loc1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vlapl"].flatten()
    ref_tgt = [1.200694778040647e-01, 1.200729446399728e-01, 1.200828028595659e-01, 1.200313077145837e-01, 1.200590794120066e-01, 1.200590794120066e-01, 8.412484461430016e-02, 8.414569677177204e-02, 8.462936687528426e-02, "nan", 8.414984612728908e-02, 2.171250000000000e-01, 4.132314333602644e-02, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 4.899791433079852e-02, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000001e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 1.577160299796410e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.280798090413369e-02, 2.369961143093766e-02, 2.089967862097600e-02, 2.162221450715755e-02, 2.431197155303810e-02, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000001e-01, 2.171250000000000e-01, 1.129413269696918e-01, 1.312085836037174e-04, 2.171250000000000e-01, 1.012167820866695e-04, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 1.922164534419437e-10, 2.171250000000000e-01, 2.171250000000001e-01, 2.576937660486150e-05, 9.316826947805998e-10, 2.171250000000001e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.163767356693595e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000001e-01, 2.171250000000000e-01, 2.171250000000000e-01, 1.063951560933936e-01, 2.171250000000000e-01, 2.979016477441579e-03, 2.171250000000001e-01, 3.398327222153840e-02, 2.171250000000000e-01, 2.171250000000000e-01, 4.151610257144155e-02, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000001e-01, 8.649689496001242e-05, 2.171250000000001e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01, 2.171250000000000e-01]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_k_csk_loc1_BrOH_cation_restr_1_vtau():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk_loc1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vtau"].flatten()
    ref_tgt = [0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05

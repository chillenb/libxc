
import pylibxc
import pytest
import numpy
from pylibxc.example_densities import test_data


def test_mgga_k_csk1_BrOH_1_zk():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["zk"].flatten()
    ref_tgt = [2.249528190363210e+03, 2.249529706818627e+03, 2.249558152212628e+03, 2.249532716282516e+03, 2.249528803603458e+03, 2.249528803603458e+03, 6.410636330775581e+01, 6.410355004915786e+01, 6.403175890463812e+01, "nan", 6.410546245649992e+01, 5.181366170830967e+158, 3.068311190972533e+00, 3.127163210582630e+247, 6.317117475825837e+160, 3.542966774554630e+213, 1.449211165307237e+160, 3.338611122176177e+213, 2.426664661759167e+98, 1.745579737919651e+215, 3.708924437727581e+00, 2.266959352016334e+230, 1.947316365402886e+215, 1.615865045015588e+244, 9.932124383602412e+173, 6.747160968894717e+204, 9.316309724994226e+226, 3.474763938672119e+234, 3.041611628292622e+275, 2.541877924632235e+185, 1.803786241054055e+171, 3.628852446099623e+244, 2.373172465009275e+206, 1.286596510182743e+02, 2.159612586794027e+225, 3.001332121895265e+177, 3.231593628999997e+01, 3.223978390157824e+01, 3.288958911553074e+01, 3.282243306931500e+01, 3.154684478414113e+01, 3.448861069320511e+159, 1.696412366884657e+180, 2.326219773300338e+218, 2.798258143781057e+180, 3.070762348049595e+218, 1.514990091094690e+180, 1.796820913107830e+00, 8.076166016099321e-01, 1.194253356703957e+201, 7.451068893204935e-01, 9.461308698134133e+66, 3.342414612704127e+162, 7.626171044449555e+249, 5.805996376148702e-01, 1.540178070712019e+167, 6.169419709177584e+282, 6.897075893767804e-01, 4.770743051188093e-01, 1.450587250346724e+167, 6.830644490704589e+237, 7.616168923459633e+226, 1.631035939651466e+00, 1.567065906859683e+209, 1.868625229398839e+164, 4.515532498415675e+242, 3.291394740449477e+228, 1.713999733762403e+161, 3.449023572287598e+228, 5.711222962981360e+199, 1.961142687737515e+246, 1.422984887098174e+00, 1.742034427970755e+247, 9.939931544416557e-01, 2.956198851660998e+224, 8.406372487275421e-01, 1.192724999519527e+176, 6.807969210733600e+198, 1.314311397792254e+00, 5.955521252940024e+255, 2.410738794842507e+255, 1.738357220445863e+253, 6.425759883138665e-01, 4.021362109906511e+253, 1.160136577980278e+256, 1.294296436082142e+265, 6.870258282628677e+50, 8.435842618046748e+182, 1.047977857974102e+230, 2.717920120094189e+257]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-08


def test_mgga_k_csk1_BrOH_1_vrho():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vrho"].flatten()
    ref_tgt = [2.779806832310105e+03, 2.779860186128121e+03, 2.780050578884370e+03, 2.779177396601759e+03, 2.779835357094616e+03, 2.779835357094616e+03, 5.683659158843496e+01, 5.684719949608667e+01, 5.714311770464924e+01, "nan", 5.684253189492397e+01, 2.943847398559341e+142, 2.587911458256744e-01, 1.099101048319773e+232, 8.299854120978226e+144, -6.408686171031664e+197, 5.197968278733903e+144, -1.176109242294122e+198, 8.648989779805343e+81, -7.508060182927921e+199, 2.019584782471001e+00, -3.108566705440070e+214, 6.270244727033256e+199, 1.672593200991521e+228, 5.645479309751429e+157, -1.325307271412593e+189, -1.949160291979774e+210, -1.751697593574262e+218, -6.386264671535064e+259, 3.978090296743076e+169, 6.909216933344034e+155, -3.171159607480551e+227, 6.916497524202567e+190, 1.875087504195248e+02, 5.835255817693752e+209, 5.812978139413726e+161, -8.793505966833727e+00, -8.012086461625406e+00, -1.000853629565842e+01, -9.402691645929517e+00, -6.679096692667155e+00, -2.463003996618649e+144, 1.773600485033962e+164, 5.267053627659431e+202, -4.610122701100891e+164, 6.703440998808902e+202, 5.235759740565976e+164, 2.186828647357733e+00, -8.010098892633951e-01, 2.663720699577967e+185, -7.383161770997742e-01, 4.722911523154184e+51, 1.437433329415714e+147, 3.338543103253939e+233, -5.805995852144745e-01, -1.361468961431250e+151, 1.887418146464597e+267, -6.885299892317859e-01, -4.770742301436279e-01, 4.640795179769941e+151, 1.967228473367239e+222, -3.122436800053677e+211, 2.674216492590737e+00, -8.900326303703339e+192, -4.187135965402024e+148, -1.257653464775094e+227, 7.862669550585454e+212, 3.023736339126594e+145, 9.404298600583375e+212, 2.338835974807258e+184, 1.542652750496364e+230, 1.706340521547454e+00, -3.733847458284233e+231, -8.351756590394664e-01, 6.376888163819135e+208, 9.026018736059255e-02, -3.901052248743033e+159, -2.099351260986807e+180, 3.522788911118084e-01, 2.303783204046766e+240, 2.181652063260440e+240, -5.667953976734618e+237, -6.389555374647014e-01, 1.258046769088962e+238, 3.032876596354003e+240, -8.067205242408658e+249, -5.889322896382203e+34, -6.393690746998066e+166, 3.787981578429515e+214, 5.334717242851125e+241]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_k_csk1_BrOH_1_vsigma():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vsigma"].flatten()
    ref_tgt = [2.454554366499601e-06, 2.454459350576704e-06, 2.454133684075246e-06, 2.455688676468291e-06, 2.454503463641381e-06, 2.454503463641381e-06, 8.003526352557014e-04, 8.002309615145238e-04, 7.967831748368814e-04, "nan", 8.002798296812292e-04, 1.664885747428966e-04, 1.651320168038570e-01, 2.371089894750390e-02, 2.571085085416391e-02, 2.511302609544829e-02, 2.366452568393156e-02, 2.366452568393156e-02, 1.154549423168824e+00, 1.109632128882583e+00, 8.039385369831899e-02, 3.029699961466519e+00, 1.140825370931601e+00, 1.140825370931601e+00, 6.627170873969103e+03, 5.766654701545130e+03, 8.587779736257212e+01, 6.002474578053267e+04, 5.950761508640646e+03, 5.950761508640646e+03, 4.966481484388988e-05, 4.963832541585424e-05, 4.966201910325284e-05, 1.097283781240043e-04, 4.965134880217488e-05, 4.965134880217488e-05, 7.235488242267029e-03, 7.042655276754742e-03, 7.356192673621760e-03, 7.204005915228958e-03, 6.947200194696268e-03, 9.137290376552186e-04, 3.582056968717880e-02, 2.794751848419684e-02, 4.192477159677918e-02, 3.694740853876635e-02, 3.198975036394844e-02, 1.120671214428071e-01, 6.864912713538401e+01, 1.130085553678851e+00, 7.134559017292391e+01, 9.931433794022008e-04, 4.940810476441973e+00, 4.940810476441973e+00, 6.017464801807303e+05, 4.479387102161443e+04, 1.063885373940969e+05, 2.852211275987038e+02, 5.329472596686891e+05, 5.921636393025101e+04, 3.260261338661207e-02, 3.313039838056557e-02, 3.295758225614456e-02, 3.279392370300551e-02, 3.286687544179676e-02, 3.286687544179676e-02, 3.595445566521904e-02, 5.507454277017259e-02, 4.832473560024299e-02, 4.301658326993700e-02, 4.561842194817579e-02, 1.635355501309758e-01, 2.424595009836341e-02, 4.961159597315842e+00, 3.390414310804853e-01, 1.125236725742661e+00, 2.345187703252563e-01, 2.345187703252564e-01, 4.926985530004583e-01, 1.080934593603283e+02, 4.356798783086257e+01, 1.923693529952400e-01, 1.284459214109621e+02, 1.428675369803361e+01, 4.116746290816192e+03, 2.182732475721235e+06, 3.184120632844689e+05, 1.645353996032587e+01, 9.646901028340467e+04, 9.646901028340506e+04]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_k_csk1_BrOH_1_vlapl():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vlapl"].flatten()
    ref_tgt = [1.163238574551270e-01, 1.163260944025854e-01, 1.163328444509906e-01, 1.162962502765239e-01, 1.163250633752982e-01, 1.163250633752982e-01, 8.735050818123720e-02, 8.736510296817022e-02, 8.776696296005558e-02, "nan", 8.735801441667020e-02, 1.666666666666667e-01, 4.196075309423533e-02, 1.666666666666667e-01, 1.666666666666666e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666666e-01, 1.666666666666667e-01, 6.552172599044705e-02, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666666e-01, 1.666666666666666e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.414495903025416e-01, 1.666666666666667e-01, 1.666666666666667e-01, 2.664407946311803e-02, 2.759823099355764e-02, 2.535406048576379e-02, 2.606699364013037e-02, 2.910146889835568e-02, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666666e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.145162577024569e-01, 2.851776461004386e-04, 1.666666666666667e-01, 3.175871803720114e-04, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 3.172825838094162e-09, 1.666666666666667e-01, 1.666666666666667e-01, 5.977431217887631e-05, 5.524785424726832e-09, 1.666666666666667e-01, 1.666666666666666e-01, 1.666666666666667e-01, 1.666554814190624e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.128154650636725e-01, 1.666666666666667e-01, 5.526259258447175e-03, 1.666666666666666e-01, 4.302504528385355e-02, 1.666666666666667e-01, 1.666666666666667e-01, 5.075286701150974e-02, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.966592536677272e-04, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666667e-01, 1.666666666666666e-01, 1.666666666666667e-01, 1.666666666666667e-01]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_k_csk1_BrOH_1_vtau():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_k_csk1", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vtau"].flatten()
    ref_tgt = [0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05

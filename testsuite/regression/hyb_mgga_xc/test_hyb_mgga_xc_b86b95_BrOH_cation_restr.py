
import pylibxc
import pytest
import numpy
from pylibxc.example_densities import test_data


def test_hyb_mgga_xc_b86b95_BrOH_cation_restr_1_zk():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("hyb_mgga_xc_b86b95", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["zk"].flatten()
    ref_tgt = [-1.439568732482691e+01, -1.439572594845562e+01, -1.439591046417615e+01, -1.439533547391206e+01, -1.439563493765065e+01, -1.439563493765065e+01, -2.459093599011209e+00, -2.459078028619963e+00, -2.458710333712171e+00, -2.459072307198359e+00, -2.458788382937355e+00, -4.613738843763755e+00, -5.828400453270137e-01, -9.009709531920921e-01, -8.761368958050916e-01, -8.838901857840120e-01, -8.822321361020322e-01, -8.822321361020322e-01, -2.370370831576045e-01, -2.408200532796407e-01, -7.421606074011411e-01, -1.773388911462303e-01, -2.004351066338166e-01, -2.004351066338165e-01, -7.926600581512698e-03, -8.343304048763274e-03, -4.619326625450079e-02, -4.577155157476113e-03, -5.751860556355314e-03, -5.751860556355313e-03, -6.901737175818702e+00, -6.903029276901743e+00, -6.901801788229623e+00, -3.562148126190730e+00, -6.902389394207167e+00, -6.902389394207167e+00, -1.439032422706244e+00, -1.445422260214154e+00, -1.434650394590118e+00, -1.440138615386052e+00, -1.444691057677148e+00, -2.624294479646155e+00, -7.986179137052698e-01, -8.684924543004110e-01, -7.384593142094383e-01, -7.688837252527169e-01, -8.116813941587862e-01, -4.563034453035815e-01, -4.552272780385100e-01, -2.350544764674840e-01, -4.883736506901662e-01, -2.564495141213435e+00, -1.440989345308597e-01, -1.440989345308597e-01, -3.260616159426711e+01, -4.474544571198717e-03, -3.421593129861117e-03, -7.028794623469631e-01, -1.371546286488955e+01, -4.121912227504523e-03, -8.072631602859626e-01, -8.021194192299810e-01, -4.299835112264551e-01, -8.054191074065846e-01, -8.046723052576930e-01, -8.046723052576930e-01, -7.858460549103143e-01, -6.718970912211627e-01, -7.045689557520671e-01, -7.369480749171884e-01, -7.204164270800081e-01, -4.013414468780422e-01, -9.089016196950654e-01, -2.736597302325511e-01, -3.592037133689601e-01, -3.050386230900800e-01, -4.137058766746709e-01, -4.137058766746709e-01, -3.716231196428573e-01, -4.420205724272015e-02, -6.038448364845409e-02, -4.607645144410939e-01, -4.592285627182656e-01, -9.643391811812728e-02, -1.118765941660857e-02, -1.196009308328521e-03, -2.510555226544839e-03, -9.048951537290485e-02, -3.814067628789540e-03, -3.814067628789536e-03]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-08

# test_hyb_mgga_xc_b86b95_BrOH_cation_restr_1_vrho() not generated due to NaN in reference data

# test_hyb_mgga_xc_b86b95_BrOH_cation_restr_1_vsigma() not generated due to NaN in reference data


def test_hyb_mgga_xc_b86b95_BrOH_cation_restr_1_vtau():
    # Prepare the input
    inp = test_data["BrOH_cation_restr"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("hyb_mgga_xc_b86b95", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vtau"].flatten()
    ref_tgt = [-3.917476094290055e-05, -3.917456290562790e-05, -3.917362137932091e-05, -3.917656909685308e-05, -3.917503319995349e-05, -3.917503319995349e-05, -9.886250054216535e-04, -9.886212963460517e-04, -9.884934715953247e-04, -9.883894443422218e-04, -9.885791352840607e-04, -1.092890167284502e-04, -1.592853529406604e-02, -5.685700042247030e-04, -4.648129682438896e-04, -5.139818280660836e-04, -5.022363367313802e-04, -5.022363367313802e-04, -2.272476539174919e-03, -2.438635333769843e-03, -1.238371199050499e-02, -6.228892557979323e-04, -1.124305293517300e-03, -1.124305293517299e-03, -3.204729070861083e-07, -3.855175240946730e-07, -1.991413646192578e-05, -4.988686685971546e-08, -1.326836629820020e-07, -1.326836629820020e-07, -2.260367971782170e-04, -2.271288073430429e-04, -2.261000879123792e-04, -4.880334250829034e-04, -2.265829779956127e-04, -2.265829779956127e-04, -2.661303104094819e-03, -2.628685277403782e-03, -2.685517452651573e-03, -2.656249081361493e-03, -2.631732964054590e-03, -2.290778277697597e-04, -3.980651631573461e-03, -6.402809383628741e-03, -2.954762597660942e-03, -4.309697953295984e-03, -4.345624039846454e-03, -1.929735692306609e-02, -3.460331214744272e-01, -9.414838695722697e-04, -3.870885540310496e-01, -6.625392309547946e-04, -5.032062162522918e-04, -5.032062162522921e-04, -3.156062561985356e+01, -4.134727186741635e-08, -1.556221706271906e-07, -6.787815240163054e-01, -2.642940795733916e+01, -1.015876081719198e-07, -1.552468435401276e-02, -1.269737312846192e-02, -1.976885817934797e-02, -1.441831558918538e-02, -1.399960176047655e-02, -1.399960176047655e-02, -1.574997737406090e-02, -4.123336256814151e-03, -5.890729233565684e-03, -8.626635291583489e-03, -7.072833338322452e-03, -2.357026059631729e-02, -5.028715317686327e-03, -9.384751940055865e-02, -2.033973732592932e-03, -4.576736496754310e-02, -2.971284313366229e-03, -2.971284313366229e-03, -3.001494066796270e-02, -1.798465892885614e-05, -3.609275702144947e-05, -5.873978700190716e-03, -4.830320359587126e-01, -1.992430445642115e-04, -4.006917532914426e-07, -1.135208051828429e-09, -2.781011732063595e-08, -1.840090343808162e-04, -1.160538313713013e-07, -1.160538313713013e-07]
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05

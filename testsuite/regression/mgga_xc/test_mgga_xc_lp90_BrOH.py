
import pylibxc
import pytest
import numpy
from pylibxc.example_densities import test_data

# test_mgga_xc_lp90_BrOH_1_zk() not generated due to NaN in reference data

# test_mgga_xc_lp90_BrOH_1_vrho() not generated due to NaN in reference data


def test_mgga_xc_lp90_BrOH_1_vsigma():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_xc_lp90", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vsigma"].flatten()
    ref_tgt = numpy.asarray([-6.542256521689323e-10, -6.542191435994643e-10, -6.541853154172847e-10, -6.542919947134796e-10, -6.542222598274385e-10, -6.542222598274385e-10, -1.014980508719272e-06, -1.014971950956112e-06, -1.014568973674369e-06, -1.014399303398108e-06, -1.014958737036293e-06, -1.014958737036293e-06, -7.625465742206985e-04, -7.656883114201667e-04, -8.530658428860023e-04, -8.267002016195993e-04, -7.636905800103473e-04, -7.636905800103473e-04, -1.364826475346059e-01, -1.294476103744667e-01, -3.693393362783759e-04, -4.941266766168825e-01, -1.343232971934769e-01, -1.343232971934769e-01, -1.403936812996360e+04, -1.166292615459289e+04, -4.272454523680985e+01, -2.650710042765863e+05, -1.216202532822171e+04, -1.216202532822171e+04, -2.005601809624117e-07, -2.004166398022549e-07, -2.005450301483805e-07, -2.004334249079671e-07, -2.004872077970270e-07, -2.004872077970270e-07, -1.024064368726488e-05, -9.956348680098581e-06, -1.035844302039806e-05, -1.013251124383417e-05, -9.900596480864343e-06, -9.900596480864343e-06, -1.327866057348812e-03, -9.535080094121424e-04, -1.638089529317303e-03, -1.383893944564978e-03, -1.141850713784623e-03, -1.141850713784623e-03, -1.696113103377721e+00, -1.326395162306611e-01, -1.785941852958241e+00, -1.106724778040690e-05, -9.485944698610392e-01, -9.485944698610392e-01, -3.060672841926539e+05, -1.794232826195068e+05, -5.685693645511514e+05, -1.131275773439557e+01, -2.603219073036491e+05, -2.603219073036491e+05, -1.171133761664550e-03, -1.196499659814519e-03, -1.187328281084358e-03, -1.180312603133413e-03, -1.183817460806524e-03, -1.183817460806524e-03, -1.334492614417807e-03, -2.357313628726099e-03, -1.979972455095916e-03, -1.695254847636073e-03, -1.833429671674413e-03, -1.833429671674413e-03, -7.888320272103933e-04, -5.299037742630732e-02, -2.662727976003127e-02, -9.963998648009547e-03, -1.628596989008922e-02, -1.628596989008923e-02, -3.563044811564343e-03, -5.806430822828227e+01, -1.728628991145099e+01, -1.250386626972485e-02, -3.908428211892175e+00, -3.908428211892174e+00, -7.441233171575288e+03, -3.193473979103908e+07, -2.452331081162513e+06, -4.718217089728865e+00, -4.990075737824275e+05, -4.990075737824304e+05])
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05


def test_mgga_xc_lp90_BrOH_1_vlapl():
    # Prepare the input
    inp = test_data["BrOH"]

    # Get the functional
    feval = pylibxc.LibXCFunctional("mgga_xc_lp90", 1)

    # Evaluate the data
    out = feval.compute(inp, do_exc=True, do_vxc=True, do_fxc=False, do_kxc=False, do_lxc=False)
    tgt = out["vlapl"].flatten()
    ref_tgt = numpy.asarray([1.264730817966342e-05, 1.264727445459062e-05, 1.264709916504891e-05, 1.264765192865145e-05, 1.264729060179765e-05, 1.264729060179765e-05, 8.467082939568565e-05, 8.467064858944562e-05, 8.466213329346402e-05, 8.465854723925235e-05, 8.467036940686843e-05, 8.467036940686843e-05, 4.480473917805746e-04, 4.485093502519939e-04, 4.608224276183853e-04, 4.572108196390462e-04, 4.482157704287714e-04, 4.482157704287714e-04, 1.641845978032543e-03, 1.620251820964888e-03, 3.735888809951995e-04, 2.265198071047887e-03, 1.635308433214410e-03, 1.635308433214410e-03, 2.942299628838296e-02, 2.808995749945880e-02, 6.909777379560248e-03, 6.133373291616185e-02, 2.838578192089405e-02, 2.838578192089405e-02, 5.608715300113691e-05, 5.607692077398180e-05, 5.608607324560618e-05, 5.607811757165045e-05, 5.608195184849676e-05, 5.608195184849676e-05, 1.517767345293507e-04, 1.507043110143851e-04, 1.522145626110687e-04, 1.513714981465600e-04, 1.504913150284887e-04, 1.504913150284887e-04, 5.148601569127402e-04, 4.738584144735191e-04, 5.426682745360065e-04, 5.202191436485233e-04, 4.957537183324134e-04, 4.957537183324134e-04, 3.083676142643063e-03, 1.630155785291235e-03, 3.123733406947120e-03, 1.547729944294619e-04, 2.666551015331012e-03, 2.666551015331012e-03, 6.357895083190566e-02, 5.563238852876944e-02, 7.422601084010456e-02, 4.956308533286896e-03, 6.105714376760266e-02, 6.105714376760266e-02, 4.989092897830328e-04, 5.015952612421784e-04, 5.006290858834936e-04, 4.998862212261835e-04, 5.002577506031883e-04, 5.002577506031883e-04, 5.155027186970172e-04, 5.944755129836859e-04, 5.690588285753485e-04, 5.473518449714426e-04, 5.582021452738183e-04, 5.582021452738183e-04, 4.518692950152392e-04, 1.295780017342316e-03, 1.090790965640544e-03, 8.528861649165819e-04, 9.645028666043604e-04, 9.645028666043604e-04, 6.592755478628820e-04, 7.460661636376376e-03, 5.510636865152434e-03, 9.027675489766364e-04, 3.799584308130168e-03, 3.799584308130168e-03, 2.510488949656237e-02, 2.032031215858296e-01, 1.069687924311010e-01, 3.982777753049752e-03, 7.184339018942366e-02, 7.184339018942378e-02])
    error = numpy.max(numpy.abs(tgt-ref_tgt))/(1.0+numpy.max([numpy.abs(tgt), numpy.abs(ref_tgt)]))
    assert error < 5e-05
